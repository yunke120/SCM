#include "dac0832.h"

/**
	频率告诉我们正弦曲线完成整个周期的速度。
	幅度指定波形的水平轴和垂直位置之间的最大距离。例如，振幅为5 V的正弦波的最大值为+5 V，最小值为C5V。
	
	定时器2配置：
	假如波形是100HZ，即在100HZ内需要显示一个完整的波形，即在10ms内打完256个点，
	现在通过定时器每来一个中断打一个点，则定时器的中断时间应该是10ms/256 = 25600HZ -> arr=1405
	20000HZ -> 5_120_000HZ -> arr=6
	
	ADC读取的值为0-4095 将其映射到arr[6, 1405] 上，arr = (1405-6)/4095 * ADC
	

**/

/**
 * @brief 正弦波码表
 * 
 */
unsigned char const sin_code[256]={
128, 131, 134, 137, 140, 144, 147, 150, 153, 156, 159, 162, 
165, 168, 171, 174, 177, 179, 182, 185, 188, 191, 193, 196, 
199, 201, 204, 206, 209, 211, 213, 216, 218, 220, 222, 224, 
226, 228, 230, 232, 234, 235, 237, 239, 240, 241, 243, 244, 
245, 246, 248, 249, 250, 250, 251, 252, 253, 253, 254, 254, 
254, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 253, 
253, 252, 251, 250, 250, 249, 248, 246, 245, 244, 243, 241, 
240, 239, 237, 235, 234, 232, 230, 228, 226, 224, 222, 220, 
218, 216, 213, 211, 209, 206, 204, 201, 199, 196, 193, 191, 
188, 185, 182, 179, 177, 174, 171, 168, 165, 162, 159, 156, 
153, 150, 147, 144, 140, 137, 134, 131, 128, 125, 122, 119, 
116, 112, 109, 106, 103, 100, 97, 94, 91, 88, 85, 82, 
79, 77, 74, 71, 68, 65, 63, 60, 57, 55, 52, 50, 
47, 45, 43, 40, 38, 36, 34, 32, 30, 28, 26, 24, 
22, 21, 19, 17, 16, 15, 13, 12, 11, 10, 8, 7, 
6, 6, 5, 4, 3, 3, 2, 2, 2, 1, 1, 1, 
1, 1, 1, 1, 2, 2, 2, 3, 3, 4, 5, 6, 
6, 7, 8, 10, 11, 12, 13, 15, 16, 17, 19, 21, 
22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 43, 45, 
47, 50, 52, 55, 57, 60, 63, 65, 68, 71, 74, 77, 
79, 82, 85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 
116, 119, 122, 125, 
}; 

/**
 * @brief 矩形波码表
 * 
 */
unsigned char const rect_code[256] = {
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00
};

/**
 * @brief 关闭dac0832传输
 * 
 */
static void dac0832_close(void)
{
	HAL_GPIO_WritePin(DAC_WR1_GPIO_Port, DAC_WR1_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(DAC_WR2_GPIO_Port, DAC_WR2_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(DAC_XFER_GPIO_Port, DAC_XFER_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(DAC_CS_GPIO_Port, DAC_CS_Pin, GPIO_PIN_SET);
}

/**
 * @brief 打开dac0832传输
 * 
 */
static void dac0832_open(void)
{
	HAL_GPIO_WritePin(DAC_WR1_GPIO_Port, DAC_WR1_Pin, GPIO_PIN_RESET);
	HAL_GPIO_WritePin(DAC_WR2_GPIO_Port, DAC_WR2_Pin, GPIO_PIN_RESET);
	HAL_GPIO_WritePin(DAC_CS_GPIO_Port, DAC_CS_Pin, GPIO_PIN_RESET);
	HAL_GPIO_WritePin(DAC_XFER_GPIO_Port, DAC_XFER_Pin, GPIO_PIN_RESET);
}

/**
 * @brief dac0832写8位数据
 * 
 * @param data 要写进去的数据 [0，255]
 */
static void adc0832_write(uint8_t data)
{
	dac0832_open();
	HAL_GPIO_WritePin(D0_GPIO_Port, D0_Pin, (data & 0x01)?1:0);
	HAL_GPIO_WritePin(D1_GPIO_Port, D1_Pin, (data & 0x02)?1:0);
	HAL_GPIO_WritePin(D2_GPIO_Port, D2_Pin, (data & 0x04)?1:0);
	HAL_GPIO_WritePin(D3_GPIO_Port, D3_Pin, (data & 0x08)?1:0);
	HAL_GPIO_WritePin(D4_GPIO_Port, D4_Pin, (data & 0x10)?1:0);
	HAL_GPIO_WritePin(D5_GPIO_Port, D5_Pin, (data & 0x20)?1:0);
	HAL_GPIO_WritePin(D6_GPIO_Port, D6_Pin, (data & 0x40)?1:0);
	HAL_GPIO_WritePin(D7_GPIO_Port, D7_Pin, (data & 0x80)?1:0);
	dac0832_close();
}

/**
 * @brief 产生波形函数方式一，参考网友写法，未使用
 * 
 * @param info 波形相关信息结构体
 */
void generate_wave(wave_info_t *info)
{
	unsigned int i = 0;
	if(info->type == Sin)
	{
		do{
			adc0832_write(sin_code[i]);
			i=i+1;
		}while(i<256);
	}
	else if(info->type == Rect)
	{
		do{
			adc0832_write(rect_code[i]);
			i=i+1;
		}while(i<256);
	}
}

/**
 * @brief 产生波形函数方式二
 * 
 * @param i 指256个数据中的索引
 * @param info 波形相关信息结构体
 */
void generate_wave2(uint8_t i, wave_info_t *info)
{
	if(info->type == Sin)
			adc0832_write((int)(sin_code[i]/3.0*info->ampl));
	else if(info->type == Rect)
			adc0832_write(rect_code[i]);

}


